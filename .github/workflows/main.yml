name: Deploy fze.erpcode.live

on:
  push:
    branches:
      - main

jobs:
  deploy:
    runs-on: ubuntu-latest

    steps:
      # 1️⃣ Checkout code
      - name: Checkout repository
        uses: actions/checkout@v4

      # 2️⃣ Install sshpass for password-based SFTP
      - name: Install sshpass
        run: |
          sudo apt-get update
          sudo apt-get install -y sshpass

      # 3️⃣ Upload files via SFTP to /deploy
      - name: Upload files via SFTP
        run: |
          echo "Uploading files to /deploy via SFTP..."
          sshpass -p "${{ secrets.SFTP_PASS }}" sftp -o StrictHostKeyChecking=no ${{ secrets.SFTP_USER }}@${{ secrets.SFTP_HOST }} <<EOF
          cd deploy
          lcd .
          mput *
          bye
          EOF

      # 4️⃣ Sync deploy → live and reload Apache via root SSH
      - name: Sync deploy to live and reload Apache
        uses: appleboy/ssh-action@v1.0.3
        with:
          host: ${{ secrets.SSH_HOST }}
          username: ${{ secrets.SSH_USER }}
          password: ${{ secrets.SSH_PASS }}
          script: |
            set -e
            DEPLOY=/var/www/fze.erpcode.live/deploy
            LIVE=/var/www/fze.erpcode.live

            echo "Syncing /deploy → live folder..."
            rsync -a --delete --exclude deploy/ $DEPLOY/ $LIVE/

            echo "Clearing deploy folder..."
            rm -rf $DEPLOY/*

            echo "Reloading Apache..."
            systemctl reload apache2
